<?php

    //calculate the user time offset
    if ($offset<0){
    $sign='-';
    $value=$offset*(-1);
  ;
  }
    else{
    $value=$offset*(-1);
} 
use Phalcon\Tag as Tag;
$office_start_time = '08:00:00';
$office_end_time = '17:00:00';
//print_r($user);exit;
?>
<?php
echo Tag::javascriptInclude('js/jquery.min_one.js');

?>
<!-- Content Header (Page header) -->
<section class="content-header">
    <h1>
        Attendance list
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
        <li class="active">attendance list</li>
    </ol>
</section>

<!-- Main content -->
<section class="content">
    <div class="buttons">
        <form id="frm_search" action="<?=$this->url->getBaseUri();?>attendancelist/index/todaylist">
            <select class="select" data-toggle="select" name="namelist" id="namelist">
                <option>Name</option>
                <?php
                foreach ($uname as $result) {
                    ?>
                    <option><?php echo $result['member_login_name']; ?></option>

                    <?php
                }
                ?>


            </select>
            <input type="submit" class="button" value="Search" id="search">
            <!--       <a href="#" class="button" id="search">Search</a>-->
            <a href="#" class="button export">Export</a>
        </form>
    </div>

    <div class="row">
        <div class="col-md-12"><!--start table content--->
                     <table class="listtbl">
                <thead>
                    <tr>
                       
                        <th width="150px">Date</th>
                        
                        <th width="150px">User Name</th>
                        <th width="150px">Check In</th>
                        <th width="150px">Late</th>
                        <th width="150px">Check Out</th>
                        <th width="150px">Working Time</th>
                        <th width="150px">OverTime</th>
                        <th width="150px">Location</th>
                    </tr>

                </thead>
                <tbody>
                    <?php
                    foreach ($attlist->items  as $result) {
                        ?>
                        <tr>
                           
                            <td><?php
                                $date = date('Y-m-d');
                                echo $date;
                                ?></td>
                            
                            <td><?php echo $result['member_login_name']; ?></td>
                            <td>
                                <?php
                               $checkintime=$result['checkin_time'];
        if ($sign=='-'){
            $time = new DateTime($checkintime);
        $time->add(new DateInterval('PT' . $value . 'M'));
        echo $time->format('H:i:s A ');
        }
        else{
         $datetime_from = date(" H:i",strtotime($value." minutes",strtotime($checkintime)));
            echo $datetime_from;
        }
     ?>
                                
                            </td>
                            <td>
                                <?php
                                //calculate late time
                               $checkintime=$result['checkin_time'];
        $dt = new DateTime($checkintime);
        $time = $dt->format('H:i:s');
        $office_start_time='01:30:00 ';
        if($time>$office_start_time){
            $start=strtotime($office_start_time);
            $end=strtotime($time);
            $late=$end-$start;
        
            echo "<font color='red'>". gmdate("H:i:s",$late)." Hours</font>";
            
        }
        ?>
                            </td>
                            <td>
                               <?php $checkouttime= $result['checkout_time'];
        if($checkouttime==0){
        echo "-";}
        else{
            if($sign='-'){
        $time = new DateTime($checkouttime);
        $time->add(new DateInterval('PT' . $value . 'M'));
        echo  $time->format('H:i:s A');}
        else {
            $datetime_from = date(" H:i",strtotime($value." minutes",strtotime($checkouttime)));
            echo $datetime_from;
        }
        }
?></td>
                            <td>
                                <?php
                                //calculate working time
                                $start_time = strtotime($result['checkin_time']);
                                $end_time = strtotime($result['checkout_time']);
                                if ($end_time == 0) {
                                    echo "-";
                                } else {
                                    $workingHour = $end_time - $start_time;
                                    $hours = floor($workingHour / 3600);
                                    $minutes = floor(($workingHour / 60) % 60);
                                    $seconds = $workingHour % 60;
                                    echo "$hours:$minutes:$seconds";echo" Hours";
                                   
                                }
                                ?>
                            </td>
                            <td>
                                <?php
                                //calculate overtime
                                $workingHour = $end_time - $start_time;
                                if ($workingHour > 28800) {
                                    $workingHour = $workingHour - 28800;
                                    echo gmdate("H:i:s", $workingHour);
                                   
                                } else {
                                    echo "-";
                                }
                                ?> 
                                
                            </td>
                            <td><?php $lat= $result['lat'];
                $lng=$result['lng'];
                $url = 'http://maps.googleapis.com/maps/api/geocode/json?latlng='.trim($lat).','.trim($lng).'&sensor=false';
                $json = @file_get_contents($url);
                $data=json_decode($json);
                $status = $data->status;
                if($status=="OK"){
                echo  $data->results[5]->formatted_address;
//                    print_r($data);
                }
                else{
                echo "-";}
        ?></td>
                        </tr>
                        <?php
                    }
                    ?>

                </tbody>
            </table>      
        </div><!--end table content--->
    </div><!-- /.row -->

  <a href="todaylist">First</a>
<a href="todaylist?page=<?= $attlist->before; ?>&month=<?php echo ((isset($m)) ? $m : ''); ?>">Previous</a>
<a href="todaylist?page=<?= $attlist->next; ?>&month=<?php echo ((isset($m)) ? $m : ''); ?>">Next</a>
<a href="todaylist?page=<?= $attlist->last; ?>&month=<?php echo ((isset($m)) ? $m : ''); ?>">Last</a>

<?php echo "You are in page ", $attlist->current, " of ", $attlist->total_pages; ?>
