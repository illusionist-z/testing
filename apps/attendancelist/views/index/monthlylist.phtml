<?php
//calculate the user time offset
if ($offset < 0) {
    $sign = '-';
    $value = $offset * (-1);
} else {
    $value = $offset * (-1);
}


$length = count($Month);
//print_r($Getname);
//echo $Name.'aa';
?>

<!-- Content Header (Page header) -->
<section class="content-header">
    <h1>
        Monthly Attendance list
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
        <li class="active">attendance list</li>
    </ol>
</section>

<!-- Main content -->
<section class="content">
    <div class="buttons">
        <!--        <form action="monthlysearch" method="post">-->
        <form onsubmit="return false;" method="post">
            <select class="select" data-toggle="select" name="year" id="year">
                <option value="">Year</option>
<?php
$thisyr = date("Y");
for ($i = 2012; $i <= $thisyr; $i++) {
    ?>
                    <option value="<?php echo $i; ?>"
                    <?php echo(isset($Year) && ($Year == $i) ? ' selected="selected"' : ''); ?>     
                            ><?php echo $i; ?></option>
                    <?php
                }
                ?>

            </select>

            <select class="select" data-toggle="select" name="month" id="month">
                <option value="">Month</option>
<?php
for ($i = 1; $i <= $length; $i++) {
    ?>
                    <option value="<?php
                    if ($i < 10) {
                        echo '0' . $i;
                    } else {
                        echo $i;
                    }
                    ?>"
                    <?php echo(isset($Mth) && ($Mth == $i) ? ' selected="selected"' : ''); ?>
                            ><?php echo $Month[$i]; ?></option>
                    <?php
                        }
                        ?>

            </select>
            <select class="select" data-toggle="select" name="username" id="username">
                <option value="">Name</option>
<?php
//print_r($Getname);
foreach ($Getname as $getname) {
    ?>
                    <option value="<?php echo $getname['member_login_name']; ?>"
                    <?php echo(isset($Name) && ($Name == $getname['member_login_name']) ? ' selected="selected"' : ''); ?>
                            ><?php echo $getname['member_login_name']; ?></option>
                    <?php
                }
                ?>
            </select>
            <!-- <a href="../search/search" class="button" id='btn_search'>Search</a> -->
            <input type="submit" value="Search" class="buttonn" id="sub">
            <input type="hidden" value='' id='hidden-type' name='ExportType'/>
            <a href="" class="button export" onclick="Export.Export.apply(this, [$('table.listtbl'), 'monthly_list.csv']);">Export</a>

        </form>
    </div>

    <div class="row">
<?php //$this->partial('attendance/showlist');  ?>
        <div class="col-md-12"><!--start table content--->
            <table class="listtbl">
                <thead>
                    <tr>
                        <th width="150px">Date</th>

                        <th width="150px">User Name</th>
                        <th width="150px">Check In</th>
                        <th width="150px">Late</th>
                        <th width="150px">Check Out</th>
                        <th width="150px">Working Time</th>
                        <th width="150px">OverTime</th>
                        <th width="150px">Place</th>
                    </tr>

                </thead>
                <tbody>
<?php
//print_r($showlist);
//***************Show monthly attendance list******************************
foreach ($showlist->items as $item) {
    ?>
                        <tr>
                            <td><?php echo $item->att_date; ?></td>

                            <td><?php echo $item->member_login_name; ?></td>
                            <td><?php
                    $checkintime = $item['checkin_time'];
                    if ($sign == '-') {
                        $time = new DateTime($checkintime);
                        $time->add(new DateInterval('PT' . $value . 'M'));
                        echo $time->format('H:i:s A ');
                    } else {
                        $datetime_from = date(" H:i", strtotime($value . " minutes", strtotime($checkintime)));
                        echo $datetime_from;
                    }
    ?>
                            </td>
                            <td>
                                <?php
                                //calculate late time
                                $checkintime = $item['checkin_time'];
                                $dt = new DateTime($checkintime);
                                $time = $dt->format('H:i:s');
                                $office_start_time = '01:30:00 ';
                                if ($time > $office_start_time) {
                                    $start = strtotime($office_start_time);
                                    $end = strtotime($time);
                                    $late = $end - $start;

                                    echo "<font color='red'>" . gmdate("H:i:s", $late) . " Hours</font>";
                                }
                                ?>
                            </td>
                            <td>
                                <?php
                                $checkouttime = $item['checkout_time'];
                                if ($checkouttime == 0) {
                                    echo "-";
                                } else {
                                    if ($sign = '-') {
                                        $time = new DateTime($checkouttime);
                                        $time->add(new DateInterval('PT' . $value . 'M'));
                                        echo $time->format('H:i:s A');
                                    } else {
                                        $datetime_from = date(" H:i", strtotime($value . " minutes", strtotime($checkouttime)));
                                        echo $datetime_from;
                                    }
                                }
                                ?>
                            </td>
                            <td>
                                <?php
                                //calculate working time
                                $start_time = strtotime($item['checkin_time']);
                                $end_time = strtotime($item['checkout_time']);
                                if ($end_time == 0) {
                                    echo "-";
                                } else {
                                    $workingHour = $end_time - $start_time;
                                    $hours = floor($workingHour / 3600);
                                    $minutes = floor(($workingHour / 60) % 60);
                                    $seconds = $workingHour % 60;
                                    echo "$hours:$minutes:$seconds";
                                    echo" Hours";
                                }
                                ?>
                            </td>
                            <td>
                                <?php
                                //calculate overtime
                                
                                if ($item['overtime']!=0) {
                                   echo $item['overtime'];
                                } else {
                                    echo "-";
                                }
                                ?>
                            </td>
                            <td>
                                <?php
                                $lat = $item['lat'];
                                $lng = $item['lng'];
                                if (isset($lat) && isset($lng)) {
                                    $url = 'http://maps.googleapis.com/maps/api/geocode/json?latlng=' . trim($lat) . ',' . trim($lng) . '&sensor=false';
                                    $json = @file_get_contents($url);
                                    $data = json_decode($json);
                                    $status = $data->status;
                                    if ($status == "OK") {
                                        echo $data->results[5]->formatted_address;
//                    print_r($data);
                                    } else {
                                        echo "-";
                                    }
                                }
                                ?>
                            </td>
                        </tr>
                                <?php
                            }
                            ?>


                </tbody>
            </table>      
        </div><!--end table content--->
        <div id="test"></div>
    </div><!-- /.row -->

</section>
<div id="content"></div>
