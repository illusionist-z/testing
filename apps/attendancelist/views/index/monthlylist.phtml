<?php
    use Phalcon\Filter; 
//calculate the user time offset

if ($offset < 0) {
    $sign = '-';
    $value = $offset * (-1);
} else {
    $value = $offset * (-1);
    $sign='+';
}

$length = count($Month);
//print_r($Getname);
//echo $Name.'aa';
?>

<!-- Content Header (Page header) -->
<section class="content-header">
    <h1>
        <?= $t->_("monthlylist"); ?>
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
        <li class="active">Monthly Attendance Lists</li>
    </ol>
</section>

<!-- Main content -->
<section class="content">
    <div class="buttons">
        <!--        <form action="monthlysearch" method="post">-->
        <form onsubmit="return false;" method="post">
          
            <input type="text" name="year" id="year" class="datepicker"   placeholder="Start Date" style="margin-top: 9px;height:25px; width: 100px;">

          
                    <input type="text" name="month" id="month" class="datepicker"   placeholder="End Date" style="margin-top: 9px;height:25px; width: 100px;">
<!--            <select class="select" data-toggle="select" name="username" id="username">
                <option value="">Name</option>
                <?php
//print_r($Getname);
                foreach ($Getname as $getname) {
                    ?>
                    <option value="<?php echo $getname->full_name; ?>">
                        <?php echo $getname->full_name; ?></option>
                            <?php
                        }
                        ?>
            </select>-->
                                                 <input class="monthauto" name="username" id="username" placeholder="Search User Name">

             <!-- <input class="tags" name="username" id="username" placeholder="Search User Name">          -->
            <!-- <a href="../search/search" class="button" id='btn_search'>Search</a> -->
            <input type="submit" value="Search" class="buttonn" id="sub">
            <input type="hidden" value='' id='hidden-type' name='ExportType'/>
            <a href="" class="button export" onclick="Export.Export.apply(this, [$('table.listtbl'), 'monthly_list.csv']);"><b>Export</b></a>

        </form>
    </div>

    <div class="row">
        <?php //$this->partial('attendance/showlist');  ?>
        <div class="col-md-12"><!--start table content--->
            <table class="listtbl">
                <thead>
                    <tr>
                        <th width="150px"><?= $t->_("date"); ?></th>
                        <th width="150px"><?= $t->_("username"); ?></th>
                        <th width="150px"><?= $t->_("checkin"); ?></th>
                        <th width="150px"><?= $t->_("late"); ?></th>
                        <th width="150px"><?= $t->_("checkout"); ?></th>
                        <th width="150px"><?= $t->_("workingtime"); ?></th>
                        <th width="150px"><?= $t->_("overtime"); ?></th>
                        <th width="150px"><?= $t->_("location"); ?></th>
                    </tr>

                </thead>
                <tbody style="display: none;">
                    <?php
//***************Show monthly attendance list******************************
                    $filter = new Filter();
                    
                    foreach ($monthlylist as $item) {
                                                
                        ?>
                        <tr>
                            <td><?php echo $item->attendances->att_date; ?></td>

                            <td><?php echo $filter->sanitize($item->core->full_name, "string"); ?></td>
                            <td><?php
                                $checkintime = $item->attendances->checkin_time;
                                if ($sign == '-') {
                                    $time = new DateTime($checkintime);
                                    $time->add(new DateInterval('PT' . $value . 'M'));
                                    echo $time->format('H:i:s A ');
                                } else {
                                    $datetime_from = date(" H:i", strtotime($value . " minutes", strtotime($checkintime)));
                                    echo $datetime_from;
                                }
                                ?>
                            </td>
                            <td><?php
                                //calculate late time
                                $checkintime = $item->attendances->checkin_time;
                                $dt = new DateTime($checkintime);
                                $time = $dt->format('H:i:s');
                                $office_start_time = '01:30:00 ';
                                if ($time > $office_start_time) {
                                    $start = strtotime($office_start_time);
                                    $end = strtotime($time);
                                    $late = $end - $start;
                    if($item->attendances->notes!=''){
                                 echo "<font color='red'>". gmdate("H:i:s",$late)."(".$item->attendances->notes." )</font>";
                            }
                        else{
                             echo "<font color='red'>". gmdate("H:i:s",$late)."</font>";
                            }
                                }
                                ?>
                            </td>
                            <td><?php
                                $checkouttime = $item->attendances->checkout_time;
                                if ($checkouttime == 0) {
                                    echo "-";
                                } else {
                                    if ($sign = '-') {
                                        $time = new DateTime($checkouttime);
                                        $time->add(new DateInterval('PT' . $value . 'M'));
                                        echo $time->format('H:i:s A');
                                    } else {
                                        $datetime_from = date(" H:i", strtotime($value . " minutes", strtotime($checkouttime)));
                                        echo $datetime_from;
                                    }
                                }
                                ?>
                            </td>
                            <td><?php
                                //calculate working time
                                $start_time = strtotime($item->attendances->checkin_time);
                                $end_time = strtotime($item->attendances->checkout_time);
                                if ($end_time == 0) {
                                    echo "-";
                                } else {
                                    $workingHour = $end_time - $start_time;
                                    $hours = floor($workingHour / 3600);
                                    $minutes = floor(($workingHour / 60) % 60);
                                    $seconds = $workingHour % 60;
                                    if($hours<10){
                                        $hours="0".$hours;
                                    }
                                    if($minutes<10){
                                        $minutes="0".$minutes;
                                    }
                                    $workingHour = "$hours:$minutes:$seconds";
                                    echo $workingHour;
                                    
                                }
                                ?>
                            </td>
                            <td><?php
                                //calculate overtime
                            if ($item->attendances->overtime !=0) {
                                   echo $result['overtime'];
                                } else {
                                    echo "-";
                                }
                                  
//                                    
//                               $time = date($workingHour);               
//          
//                                    $office_start_time='08:00:00 ';
//
//                                    if($time>$office_start_time){
//                                        $start=strtotime($office_start_time);
//                                        $end=strtotime($time);
//                                        $late=$end-$start;
//                                        echo $end_time;
//                                        echo "<font color='red'>". gmdate("H:i:s",$late)."</font>";
//
//                                    }  elseif ($time<$office_start_time) {
//                                        echo '-';
//                                    }
//                                    elseif ($checkouttime == 0) {
//                                        echo '-';
//                                     }
                                    
                                                            ?></td>
                            <td><?php echo $filter->sanitize($item->attendances->location, "string")?></td>
                        </tr>
                        <?php
                    }
                    ?>
                </tbody>
                <tfoot style="display: none;"></tfoot>
            </table>      
        </div><!--end table content--->
        <div id="test"></div>
    </div><!-- /.row -->    
    <div id="content"></div>
</section> 

